#!/bin/bash -eu

bold=$(tput bold)
normal=$(tput sgr0)

usage_exit() {
  cat <<EOF
Usage: $0 [-c] [-m msg] [-x]
Generate the site.

Options are:
  -c      Will make a commit after generating.
  -m msg  Specify the commit message. That use to both the source and results.
  -v      Verbose mode.
  -x      Will generate XML files such kind of RSS feeds and Sitemaps.
  -h      Display this help and exit.
EOF
  exit 1
}

commit=false
generate_xml=false
msg="Rebuilding site $(date)"
verbose=false

while getopts cm:vxh OPT; do
  case $OPT in
    c)  commit=true
        ;;
    m)  msg=$OPTARG
        ;;
    v)  verbose=true
        ;;
    x)  generate_xml=true
        ;;
    h)  usage_exit
        ;;
    \?) usage_exit
        ;;
  esac
done

if $generate_xml; then
  cleaner='find . -not -name .git\* -delete'
  generator='hugo'
else
  # Clean up the existing contents other than feeds and repository data.
  cleaner='find . -not -name .git\* -o -not -name \*xml -delete'
  generator='hugo --disableKinds RSS,sitemap'
fi

echo; echo "${bold}Generates site contents...${normal}"

$verbose && set -x

(cd public
 git checkout master
 git reset --hard origin/master
 git clean -fdx
 $cleaner
)

$generator

# Beautifying the HTML files.
find public -name \*html -print0 \
  | xargs -0 "$(npm bin)/html-beautify" \
          --editorconfig \
          --indent-inner-html=true \
          --indent-size=2 \
          --replace \
          --type=html \
          --unformatted=script \
          --unformatted=style

if $commit; then
  (
    cd public
    git add -A
    git commit -m "$msg"
  )
  git add public
  git commit -m "$msg"
fi
